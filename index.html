<!DOCTYPE html>
<!--
  Game Title: NeonBeat
  Author: CurryTarou Works
  GitHub: https://currytarou.github.io/neonbeat-by-currytarouworks/
  Copyright (c) 2026 CurryTarou Works. All rights reserved.
  License: MIT
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <title>Dynabeats-Rhythm game-v10.0</title>
    <meta name="description" content="Early Access rhythm game with dynamically generated note charts for any music.">
    <style>
	/* @preserve Dynabeats Styles | (c) 2026 CurryTarou Works */
        /* =========================================
           1. 全域與 PC 版基礎設定
           ========================================= */
        * {
            -webkit-tap-highlight-color: transparent; /* 消除 iOS 點擊閃爍造成的 GPU 重繪干擾 */
            outline: none;
        }

        :root {
            --neon-blue: #00f3ff;
            --neon-pink: #ff0055;
            --neon-gold: #ffcc00;
            --neon-red: #ff3333;
            --bg-color: #050505;
        }
        
        body, html { margin: 0; padding: 0; background: var(--bg-color); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; user-select: none; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; }

        /* 背景層 */
        #bg-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0;
            background: #000; overflow: hidden;
        }
        #bg-video {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            min-width: 100%; min-height: 100%; width: auto; height: auto;
            object-fit: cover; opacity: 0; filter: brightness(0.4) blur(0px); transition: opacity 0.5s;
            pointer-events: none; 
        }

        /* 遊戲主舞台 */
        #gear-stage {
            position: relative; z-index: 10; 
            width: 520px; 
            height: 100vh; margin: 0 auto;
            background: rgba(10, 15, 20, 0.6);
            border-left: 4px solid #333; border-right: 4px solid #333;
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            backdrop-filter: none;
            background-image: linear-gradient(90deg, 
                transparent 24%, rgba(255,255,255,0.08) 25%, 
                transparent 26%, transparent 49%, rgba(255,255,255,0.08) 50%, 
                transparent 51%, transparent 74%, rgba(255,255,255,0.08) 75%, 
                transparent 76%);
            background-size: 100% 100%;
            
            touch-action: none;
            will-change: transform, opacity;
            backface-visibility: hidden;
        }
        
        .fever-mode-active {
            box-shadow: 0 0 80px var(--neon-gold) !important;
            border-color: var(--neon-gold) !important;
        }
        @keyframes pulse-border { from { box-shadow: 0 0 50px var(--neon-gold); } to { box-shadow: 0 0 100px var(--neon-gold); } }

        canvas { display: block; width: 100%; height: 100%; touch-action: none; }

        /* HUD (介面) */
        .hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        #song-title-display {
            position: absolute; top: 20px; left: 0; width: 100%; 
            display: flex; flex-direction: column; align-items: center; 
            z-index: 100; pointer-events: none;
        }
        #song-name-text { font-size: 1.2rem; font-weight: bold; text-shadow: 0 0 10px var(--neon-blue); }

        #song-progress-container {
            width: 100%; max-width: 520px; height: 4px; 
            background: rgba(255, 255, 255, 0.1); margin-top: 10px;
            border-radius: 2px; overflow: visible; 
            position: relative;
        }

        #song-progress-bar {
            width: 100%; 
            height: 100%; 
            background: var(--neon-blue);
            box-shadow: 0 0 10px var(--neon-blue); 
            transform-origin: left; 
            transform: scaleX(0);   
            will-change: transform; 
        }
        
        /* 難度顯示 */
        #difficulty-display {
            position: absolute; 
            top: 10px; 
            left: 50%; transform: translateX(-50%);
            color: var(--neon-blue); font-weight: bold; font-size: 18px;
            letter-spacing: 2px; text-shadow: 0 0 10px var(--neon-blue);
            z-index: 101; pointer-events: none; width: 100%; text-align: center;
            display: none; 
        }

        /* 手機版暫停按鈕 */
        #mobile-pause-btn {
            position: fixed; 
            top: 20px; 
            right: 20px; 
            width: 40px; 
            height: 40px; 
            border: 2px solid var(--neon-blue); 
            background: rgba(0, 0, 0, 0.5); 
            border-radius: 50%; 
            z-index: 200; 
            display: none; 
            justify-content: center; 
            align-items: center; 
            pointer-events: auto; 
            cursor: pointer;
            backdrop-filter: blur(4px);
        }
        #mobile-pause-btn::before {
            content: "||";
            color: var(--neon-blue);
            font-weight: 900;
            font-size: 16px;
            text-shadow: 0 0 5px var(--neon-blue);
        }

        /* PC版 HUD */
        #hp-bar-wrap { 
            position: absolute; left: -20px; bottom: 20%; width: 12px; height: 60%; 
            background: #222; border: 1px solid #555; border-radius: 4px; overflow: hidden;
        }
        #hp-fill { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; 
            transform-origin: bottom;
            transform: scaleY(1);
            background: linear-gradient(to top, var(--neon-blue), #fff); 
            transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1); 
            will-change: transform; 
        }

        #fever-wrap { 
            position: absolute; right: -20px; bottom: 20%; width: 12px; height: 60%; 
            background: #222; border: 1px solid #555; border-radius: 4px; overflow: hidden;
        }
        #fever-fill { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            transform-origin: bottom;
            transform: scaleY(0); 
            background: var(--neon-gold); 
            box-shadow: 0 0 15px var(--neon-gold); 
            transition: transform 0.05s linear;
            will-change: transform; 
        }
        
        #fever-txt { 
            position: absolute; top: 70%; left: 50%; transform: translate(-50%, -50%); 
            width: 100%; text-align: center;
            color: var(--neon-gold); font-weight: 900; font-size: 32px; font-style: italic;
            opacity: 0; text-shadow: 0 0 30px var(--neon-gold); letter-spacing: 2px;
            pointer-events: none; z-index: 20;
            transition: opacity 0.3s ease-in-out;
            will-change: opacity; 
        }

        #gear-stage.fever-mode-active #fever-txt {
            opacity: 1 !important;
        }

        #combo-box { display: none !important; }
        .show-combo { opacity: 1 !important; transition: opacity 0.1s !important; }

        #judge-txt {
            font-size: 54px; font-weight: 900; font-style: italic; text-align: center;
            transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: 0 0 20px currentColor, 0 0 40px currentColor; letter-spacing: 2px;
        }
        #combo-num { font-size: 90px; font-weight: 900; line-height: 1; color: #fff; }
        #combo-lbl { font-size: 20px; letter-spacing: 8px; color: #888; font-weight: bold; }

        .key-row { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: space-around; pointer-events: auto; }
        .key-cap { 
            width: 22%; text-align: center; font-size: 28px; font-weight: 900; color: #888; 
            padding: 10px 0; transition: all 0.05s;
            will-change: transform, background-color, box-shadow; 
        }
        .key-cap.active { 
            color: #000; border-color: #fff; 
            background: var(--neon-blue); box-shadow: 0 0 25px var(--neon-blue);
            transform: translateY(2px);
        }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.94); z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
        }
        .hidden { display: none !important; }

        h1 { 
            font-size: 100px; 
            color: var(--neon-blue); margin-bottom: 30px; 
            text-transform: uppercase; letter-spacing: 10px; 
            text-shadow: 0 0 30px var(--neon-blue); font-style: italic;
            white-space: nowrap; 
            text-align: center;
        }

        .btn-group { display: flex; gap: 30px; margin-top: 30px; justify-content: center; position: relative; z-index: 2; }
        
        button {
            padding: 15px 40px; font-size: 20px; font-weight: 800; color: #fff; background: transparent;
            border: 2px solid var(--neon-blue); cursor: pointer; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.2s;
        }
        button:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 40px var(--neon-blue); transform: scale(1.1); }

        .file-zone { display: flex; gap: 40px; margin-bottom: 30px; }
        .file-box { 
            border: 2px dashed #555; padding: 40px; width: 240px; text-align: center; 
            border-radius: 15px; cursor: pointer; transition: 0.3s; 
        }
        .file-box:hover { border-color: var(--neon-blue); background: rgba(0,243,255,0.1); }
        .file-box label { cursor: pointer; display: block; width: 100%; height: 100%; color: #888; font-size: 16px; font-weight: bold; }
        .file-box.selected { border-color: var(--neon-blue); background: rgba(0, 243, 255, 0.15); box-shadow: 0 0 20px rgba(0, 243, 255, 0.4); }
        input[type="file"] { display: none; }
        .setting-zone { margin-bottom: 20px; color: #aaa; font-size: 18px; display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { transform: scale(1.5); accent-color: var(--neon-blue); cursor: pointer; }

        /* 結果畫面 (PC) */
        #cd-num { font-size: 180px; font-weight: 900; color: #fff; text-shadow: 0 0 60px var(--neon-blue); }
        #res-rank { font-size: 160px; font-weight: 900; margin: 10px 0; }
        .stats-table { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 40px; text-align: left; margin: 20px 0; font-size: 24px; color: #ccc; }
        .fc-animation { font-size: 2rem; font-weight: bold; text-align: center; text-shadow: 0 0 10px #ffd700, 0 0 20px #ff8c00; animation: pulse 1s infinite alternate; }
        @keyframes pulse { from { transform: scale(1); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }
        .bar-container { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 10px; overflow: hidden; }
        .bar { height: 100%; width: 0%; transition: width 1s ease-out; }
        .chart-label { font-size: 0.8rem; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .stat-chart { width: 100%; max-width: 400px; }
        .stat-item { display: flex; justify-content: space-between; width: 100%; max-width: 400px; font-size: 20px; }

        /* 光柱特效 */
        .diff-light-pillar {
            position: fixed;
            left: 50%;
            bottom: -300px; 
            transform: translateX(-50%);
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(0, 243, 255, 0.5), rgba(0, 243, 255, 0) 90%);
            filter: blur(30px);
            z-index: 1; 
            pointer-events: none;
            animation: glow-breathe 2.5s ease-in-out infinite alternate;
        }

        @keyframes glow-breathe {
            50% { opacity: 0.5; height: 400px; width: 400px; filter: blur(5px); }
            100% { opacity: 0.5; height: 500px; width: 500px; filter: blur(8px); }
        }

        .light-pillar-wrapper {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
            pointer-events: none;
        }

        /* =========================================
           2. 手機版 RWD 覆寫設定 (螢幕 < 768px)
           ========================================= */
        @media (max-width: 768px) {
            #gear-stage { 
                width: 100%; max-width: 100%; border-left-width: 2px; border-right-width: 2px; 
                box-sizing: border-box; 
                backdrop-filter: none;
                background-color: rgba(10, 15, 20, 0.85);
            }

            #mobile-pause-btn { display: flex; }
            #box-video { display: none !important; }

            #song-title-display { width: 90%; left: 5%; }
            #song-name-text { max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

            h1 { font-size: 13vw; letter-spacing: 2px; margin-bottom: 20px; white-space: nowrap; padding-left: 10px; padding-right: 10px; box-sizing: border-box; }

            #result-screen { padding-left: 20px; padding-right: 20px; box-sizing: border-box; }

            #judge-txt { font-size: 36px; will-change: transform, opacity; backface-visibility: hidden;} 
            #combo-num { font-size: 60px; } 
            #combo-lbl { font-size: 14px; }
            #fever-txt { font-size: 20px; letter-spacing: 2px; top: 60%; }

            #hp-bar-wrap { left: 2px; bottom: 25%; width: 6px; height: 50%; border-color: rgba(255,255,255,0.3); }
            #fever-wrap { right: 2px; bottom: 25%; width: 6px; height: 50%; border-color: rgba(255,255,255,0.3); }

            #song-progress-container { width: 100%; }
            #difficulty-display { font-size: 16px; top: 15px; }

            .file-zone { flex-direction: column; align-items: center; gap: 15px; width: 100%; }
            .file-box { width: 100%; padding: 20px; box-sizing: border-box; }
            
            .btn-group { flex-wrap: wrap; justify-content: center; gap: 10px; }
            button { padding: 10px 20px; font-size: 16px; min-width: 100px; }

            .key-row { bottom: 8vh !important; height: 14vh !important; align-items: flex-end; padding-bottom: 0; }
            .key-cap { 
                width: 24.5%; height: 100%; display: flex; align-items: flex-end; justify-content: center; 
                padding-bottom: 15px; border-bottom: 4px solid rgba(255,255,255,0.1);
                background: linear-gradient(to top, rgba(255,255,255,0.05), transparent);
            }
            .key-cap.active { border-bottom-color: #fff; background: linear-gradient(to top, var(--neon-blue), transparent); box-shadow: none !important;}

            #cd-num { font-size: 40vw; }
            #res-rank { font-size: 30vw; }
        }

        .setting-item { display: flex; align-items: center; gap: 15px; margin: 10px 0; }
        @media (max-width: 600px) { .setting-item { flex-direction: column; align-items: flex-start; } }

        .neon-slider {
            -webkit-appearance: none; width: 150px; height: 6px; background: #222;
            border: 1px solid var(--neon-blue); border-radius: 5px; outline: none;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        .neon-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; background: #fff;
            border-radius: 50%; cursor: pointer; box-shadow: 0 0 15px var(--neon-blue);
        }

        #volume-display { min-width: 40px; color: var(--neon-blue); font-family: 'Courier New', monospace; font-weight: bold; }
        #offset-display { min-width: 40px; color: var(--neon-blue); font-family: 'Courier New', monospace; font-weight: bold; }

	.main-logo-svg {
    	width: 80%;
    	max-width: 1000px;
    	height: auto;
    	/* 設定發光濾鏡 */
    	filter: drop-shadow(0 0 5px var(--neon-blue)) drop-shadow(0 0 15px var(--neon-blue));
    	animation: logo-glow 0.5s ease-in-out infinite alternate;
}

@keyframes logo-glow {
    from { filter: drop-shadow(0 0 5px var(--neon-blue)) drop-shadow(0 0 5px var(--neon-blue)); }
    to { filter: drop-shadow(0 0 10px var(--neon-blue)) drop-shadow(0 0 10px var(--neon-blue)); }
}
	
    </style>
</head>
<body>

    <audio id="menu-bgm" loop><source src="source/main-menu.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-clear"><source src="source/stage-clear.mp3" type="audio/mpeg"></audio>
    <audio id="bgm-fail"><source src="source/game-over.mp3" type="audio/mpeg"></audio>
    

    <div id="bg-container"><video id="bg-video" playsinline webkit-playsinline muted loop></video></div>

    <div id="mobile-pause-btn" onclick="playMenuImpact(); togglePause()"></div>

    <div id="song-title-display">
        <div id="song-name-text"></div>
        <div id="song-progress-container">
            <div id="song-progress-bar"></div>
            <div id="difficulty-display"></div>
        </div>
    </div>

    <div id="gear-stage">
        <canvas id="gameCanvas"></canvas>
        <div class="hud">
            <div id="hp-bar-wrap"><div id="hp-fill"></div></div>
            <div id="fever-wrap"><div id="fever-fill"></div></div>
            <div id="fever-txt">FEVER MODE ACTIVE</div>
           
            <div class="key-row">
                <div class="key-cap" id="k0" data-key="0">D</div>
                <div class="key-cap" id="k1" data-key="1">F</div>
                <div class="key-cap" id="k2" data-key="2">J</div>
                <div class="key-cap" id="k3" data-key="3">K</div>
            </div>
        </div>
    </div>

<div id="menu-screen" class="overlay">
    <div id="start-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,1); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer;">
        <h2 style="color:#fff; margin-bottom: 0px;">Project</h2>
	<h1 style="margin-bottom: 0px; font-size: 3rem; "><img src="source/logo.svg" class="main-logo-svg" onerror="this.style.display='none'"></h1>
        <h3 style="color:#fff; margin-top: 0px; margin-bottom: 20px; text-align: center;">Development Version</h3>
	
        <h2 style="color: var(--neon-blue); text-shadow: 0 0 15px var(--neon-blue); font-size: 30px; letter-spacing: 5px; animation: pulse 1.5s infinite;">TAP TO START</h2>
        
	<p style="color: #888; letter-spacing: 1px; margin-top: 40px; padding-left-right: 20px;">Developed by CurryTarou</p>
	<p style="color: #888; letter-spacing: 1px; margin-top: -20px; padding-left-right: 20px;">with Google Gemini</p>
	<p style="color: #888; letter-spacing: 1px; margin-top: 0px;">© 2026 CurryTarou Works</p>
    </div>

    <div id="menu-main-content" style="visibility: hidden; width: 100%; display: flex; flex-direction: column; align-items: center; overflow-y: auto; max-height: 100vh; padding: 20px; box-sizing: border-box;">
	<h2 style="color:#fff; margin-bottom: 0px;">Project</h2>
	<h1 style="margin-bottom: 0px; font-size: 3rem; "><img src="source/logo.svg" class="main-logo-svg" onerror="this.style.display='none'"></h1>
        <h3 style="color:#fff; margin-top:0px; margin-bottom: 40px; text-align: center;">Development Version</h3>
	
        <div class="file-zone">
            <div class="file-box" id="box-audio" onclick="handleBoxClick(event, 'audio')">
                <label id="label-audio" style="pointer-events: none;">
                    MUSIC MODE<br>(MP3/MP4/WAV)<br><br>
                    <span id="name-audio" style="color:var(--neon-blue)">Select File</span>
                </label>
                <input type="file" id="inp-audio" accept="audio/*, .mp3, .wav, .ogg, .m4a, .mp4" onchange="loadMedia(this.files[0], 'audio')">
            </div>
            <div class="file-box" id="box-video" onclick="handleBoxClick(event, 'video')">
                <label id="label-video" style="pointer-events: none;">
                    VIDEO MODE<br>(MP4/MOV)<br><br>
                    <span id="name-video" style="color:var(--neon-blue)">Select File</span>
                </label>
                <input type="file" id="inp-video" accept="video/*, .mp4, .webm" onchange="loadMedia(this.files[0], 'video')">
            </div>
        </div>

        <div id="diff-opt" style="display:none; text-align:center; width: 100%; position: relative;">
            <div class="light-pillar-wrapper">
    		<div class="diff-light-pillar"></div>
		</div>

            <div style="margin: -20px 0;">
                <span style="color: var(--neon-blue); margin-right: 10px;">SPEED:</span>
                <button class="diff-btn" onclick="changeSpeed(-1)" style="min-width: 40px; padding: 5px 10px;">-</button>
                <h2 id="speed-display" style="display: inline-block; width: 80px; text-align: center; font-size: 20px;">1.00x</h2>
                <button class="diff-btn" onclick="changeSpeed(1)" style="min-width: 40px; padding: 5px 10px;">+</button>
            </div>
            <p style="color:#888; margin-bottom:-20px; margin-top: 20px; letter-spacing:2px;">SELECT DIFFICULTY</p>
            <div class="btn-group">
                <button tabindex="-1" onmousedown="event.preventDefault()" onclick="playMenuImpact(); preInitGame(0.7)">EASY</button>
                <button tabindex="-1" onmousedown="event.preventDefault()" onclick="playMenuImpact(); preInitGame(1.0)">NORMAL</button>
                <button tabindex="-1" onmousedown="event.preventDefault()" onclick="playMenuImpact(); preInitGame(1.4)">HARD</button>
            </div>
        </div>
<p style="color:#888; margin-bottom: 0px; margin-top: 20px; letter-spacing:2px;">GAME SETTINGS</p>
<div class="setting-item" style="margin-bottom: 20px;">
    <span class="setting-label">VOLUME</span>
    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.4" class="neon-slider ">
    <span id="volume-display">40%</span>

    <span class="setting-label">OFFSET</span>
    <input type="range" id="offset-slider" min="-0.2" max="0.2" step="0.005" value="0.0" class="neon-slider" >
    <span id="offset-display">0.000s</span>

</div>

        <div class="setting-zone" style="margin-bottom: 20px;">
            <input type="checkbox" id="chk-fail" checked>
            <label for="chk-fail">Enable Game Over</label>
        </div>
    </div>

	<span style="color:#fff; margin-top: 30px; margin-bottom:30px; text-align: center;">© 2026 CurryTarou Works</span>
</div>

    <div id="cd-screen" class="overlay hidden"><div id="cd-num">3</div></div>

    <div id="pause-screen" class="overlay hidden">
        <h1 style="color:#fff">PAUSED</h1>
        <div class="btn-group">
            <button onclick="playMenuImpact(); resumeGame()">RESUME</button>
            <button onclick="playMenuImpact(); retryGame()">RETRY</button>
            <button onclick="playMenuImpact(); backToMenu()">TITLE</button>
        </div>
    </div>

    <div id="result-screen" class="overlay hidden">
        <h1 id="res-title">STAGE CLEAR</h1>
        <div id="res-rank">S</div>
        <div id="res-fc" class="hidden fc-animation">FULL COMBO</div>
        
        <div class="stat-item">
            <span>MAX COMBO</span>
            <span id="st-max-combo" style="color: var(--neon-gold);">0</span>
        </div>

        <div class="stat-chart">
            <div class="chart-label">PERFECT <span id="st-perf">0</span></div>
            <div class="bar-container"><div id="bar-perf" class="bar" style="background: #ffeb3b;"></div></div>
            <div class="chart-label">GREAT <span id="st-great">0</span></div>
            <div class="bar-container"><div id="bar-great" class="bar" style="background: #00f3ff;"></div></div>
            <div class="chart-label">GOOD <span id="st-good">0</span></div>
            <div class="bar-container"><div id="bar-good" class="bar" style="background: #4caf50;"></div></div>
            <div class="chart-label">MISS <span id="st-miss">0</span></div>
            <div class="bar-container"><div id="bar-miss" class="bar" style="background: #f44336;"></div></div>
        </div>

        <div style="font-size:20px; color:#888; margin: 10px 0;">SCORE: <span id="res-score" style="color:#fff">0</span></div>
        <div class="btn-group">
            <button onclick="playMenuImpact(); retryGame()">PLAY AGAIN</button>
            <button onclick="playMenuImpact(); backToMenu()">TITLE</button>
        </div>
    </div>

<script>
/*!
   * @preserve Dynabeats Game Logic
   * Author: CurryTarou Works
   * License: MIT
   */
void 0;const IS_MOBILE=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),GAME_CONFIG={COLORS:{NOTE_LANES:["#ff0055","#ffffff","#ffffff","#ff0055"],NEON_BLUE:"#00f3ff",NEON_GOLD:"#ffcc00",NEON_RED:"#ff3333",LANE_WIDTH:130,NOTE_HEIGHT:26,HIT_SCALE:5},JUDGEMENT:{WINDOW_PERFECT:.07,WINDOW_GREAT:.12,WINDOW_GOOD:.18,HIT_DETECTION_RANGE:.2,MOBILE_HIT_WINDOW_SCALE:2,SCORE_PERFECT:500,SCORE_GREAT:300,SCORE_GOOD:100,HP_GAIN_PERFECT:1.5,HP_GAIN_GREAT:1,HP_GAIN_GOOD:.5,HP_LOSS_MISS:5,RELEASE_BUFFER:.2},SPEED:{BASE_TRAVEL_TIME:1.2,OPTIONS:[.75,1,1.25,1.5,1.75,2],LABELS:["0.50x","1.00x","1.50x","2.00x","2.50x","3.00x"],FEVER_ACCEL:1.15,MOBILE_SCALE:1.1,MIN_DISPLAY_BPM:100},OFFSET:{MOBILE:0,DESKTOP:0},AUDIO:{BPM_MIN:80,BPM_MAX:170,DEFAULT_BPM:120,FFT_SIZE:1024},FEVER:{MAX_VALUE:100,GAIN_PER_HIT:1.2,DRAIN_RATE:100/720,SCORE_MULTIPLIER:2,FILTER_MIN_FREQ:3e3,FILTER_MAX_FREQ:22e3,BASS_GAIN:6}};let G={screen:"MENU",mediaEl:null,mediaType:"none",playing:!1,paused:!1,animId:null,failEnabled:!0,hp:100,score:0,combo:0,maxCombo:0,fever:0,isFever:!1,feverTimer:null,stats:{perfect:0,great:0,good:0,miss:0,maxCombo:0},masterNotes:[],notes:[],particles:[],beams:[0,0,0,0],holdingLanes:[!1,!1,!1,!1],diff:1,baseSpeed:1,currentSpeed:1,scrollSpeedIndex:1,scrollSpeed:1,bpm:120,laneEndTime:[0,0,0,0],keysHeld:[!1,!1,!1,!1],lineGlow:0,comboTimer:null,lastTapTime:[0,0,0,0],domKeys:[],audioOffset:0,baseOffset:IS_MOBILE?.575:.5,userOffset:0,virtualTime:0,lastFrameTime:0,menuFadeTimer:null,lastAnalysisTime:0,lastHudUpdate:{hp:-1,fever:-1,combo:-1},volume:.4,videoSourceNode:null,freqDataArray:null,cachedGradients:{fever:null,beams:[null,null,null,null]},currentAudioBuffer:null,touchLockTimer:0};G.audioOffset=G.baseOffset+G.userOffset;const cvs=document.getElementById("gameCanvas"),ctx=cvs.getContext("2d");let CH=window.innerHeight,CW=window.innerWidth,SCALE_X=1,JUDGE_Y=.84*CH,touchStageRect=null;function resizeCanvas(){const e=document.getElementById("gear-stage");if(e){touchStageRect=e.getBoundingClientRect(),CW=e.clientWidth,CH=e.clientHeight,cvs.width=CW,cvs.height=CH,CW<520?(SCALE_X=CW/520,JUDGE_Y=.75*CH):(SCALE_X=1,JUDGE_Y=.84*CH),G.cachedGradients.fever=ctx.createLinearGradient(0,JUDGE_Y,0,0),G.cachedGradients.fever.addColorStop(0,"rgba(255, 204, 0, 0.4)"),G.cachedGradients.fever.addColorStop(1,"rgba(255, 204, 0, 0)");const t=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X;for(let e=0;e<4;e++){const t=ctx.createLinearGradient(0,JUDGE_Y,0,0);t.addColorStop(0,GAME_CONFIG.COLORS.NOTE_LANES[e]),t.addColorStop(1,"transparent"),G.cachedGradients.beams[e]=t}}}window.onresize=resizeCanvas,window.onload=resizeCanvas;const AudioContext=window.AudioContext||window.webkitAudioContext,actx=new AudioContext,analyser=actx.createAnalyser();analyser.fftSize=GAME_CONFIG.AUDIO.FFT_SIZE;const masterGainNode=actx.createGain();masterGainNode.gain.value=.4,masterGainNode.connect(actx.destination);let mainSource=null,menuGainNode=null,menuSource=null,resultSource=null,resultGainNode=null,resultFadeTimer=null,clearSource=null,clearGain=null,failSource=null,failGain=null,feverBassNode=null,feverFilter=actx.createBiquadFilter();feverFilter.type="lowpass",feverFilter.frequency.value=GAME_CONFIG.FEVER.FILTER_MAX_FREQ;let noiseBuffer=null;function createNoiseBuffer(){const e=2*actx.sampleRate,t=actx.createBuffer(1,e,actx.sampleRate),a=t.getChannelData(0);for(let t=0;t<e;t++)a[t]=2*Math.random()-1;noiseBuffer=t}createNoiseBuffer();const sfxBus=actx.createGain();sfxBus.connect(masterGainNode);let sfxBuffers={hit:null,feverHit:null};async function preRenderSFX(){try{const e=window.OfflineAudioContext||window.webkitOfflineAudioContext;let t=new e(1,.1*actx.sampleRate,actx.sampleRate),a=t.createOscillator(),n=t.createGain();a.type="triangle",a.frequency.setValueAtTime(200,0),a.frequency.exponentialRampToValueAtTime(30,.1),n.gain.setValueAtTime(.8,0),n.gain.exponentialRampToValueAtTime(.001,.1),a.connect(n),n.connect(t.destination),a.start(0),a.stop(.1),sfxBuffers.hit=await t.startRendering();let i=new e(1,.2*actx.sampleRate,actx.sampleRate),l=i.createOscillator(),o=i.createGain();l.type="triangle",l.frequency.setValueAtTime(150,0),l.frequency.exponentialRampToValueAtTime(20,.2),o.gain.setValueAtTime(.8,0),o.gain.exponentialRampToValueAtTime(.001,.2),l.connect(o),o.connect(i.destination),l.start(0),l.stop(.2),sfxBuffers.feverHit=await i.startRendering()}catch(e){}}function generateBeatmap(e,t){if(G.masterNotes=[],!e)return;const a=e.getChannelData(0),n=e.sampleRate,i=e.duration-2,l=60/(G.bpm||120),o=l/4,c=e=>Math.round(e/o)*o;let s=t<=.7?.35:t<=1?.2:.11,r=t<=.7?.05:t<=1?.15:.3;const d=Math.floor(.015*n);let u=[],m=0,f=0;for(let e=0;e<a.length;e+=d){let t=0,i=0;for(let n=0;n<d&&e+n<a.length;n++){const l=Math.abs(a[e+n]);t+=l,i+=Math.abs(l-Math.abs(a[e+n-1]||0))}let l=t/d,o=i/d;u.push({time:e/n,low:l,high:o}),m+=l,f+=o}const E=m/u.length,g=f/u.length,h=66;for(let e=0;e<u.length;e++){let t=0,a=0,n=Math.max(0,e-Math.floor(33)),i=Math.min(u.length,e+Math.floor(33));for(let e=n;e<i;e++)t+=u[e].low,a+=u[e].high;u[e].avgLow=Math.max(.015,t/(i-n)),u[e].avgHigh=Math.max(.01,a/(i-n))}let p=[-1,-1,-1,-1],v=[null,null,null,null],T=1,y=-99;for(let e=1;e<u.length-1;e++){const a=u[e];if(a.time>i)break;if(a.time<2.5)continue;let n=c(a.time);for(let n=0;n<4;n++)if(v[n]){const i=l*(t<=1?4:6);let s=a.low<.5*a.avgLow&&a.high<.5*a.avgHigh,r=a.time-v[n].time>i,d=u[e+1]&&u[e+1].low>2*a.avgLow;if(s||r||d){let e=c(a.time);e<=v[n].time&&(e=v[n].time+o),v[n].endTime=e,v[n].endTime-v[n].time<Math.max(2*o,l)&&(v[n].isLong=!1),p[n]=e,v[n]=null}}let d=v.filter(e=>null!==e).length,m=u[e-1]?.low||0,f=u[e+1]?.low||0,h=a.low>1.4*a.avgLow&&a.low>.02&&a.low>=m&&a.low>=f,x=u[e-1]?.high||0,I=u[e+1]?.high||0,S=a.high>1.15*a.avgHigh&&a.high>.01&&(a.high>=x||a.high>=.9*I),A=a.avgLow>1.5*E&&a.avgHigh>1.4*g,_=a.avgLow>1.25*E&&a.avgHigh>1.15*g,M=s,L=r;if(A?(M=Math.max(.08,.5*s),L=Math.min(.8,2.5*r)):_?(M=Math.max(.1,.65*s),L=Math.min(.6,2*r)):a.high>1.8*a.avgHigh&&(M=.7*s),M=Math.max(o,c(M)),h||S){let a=[];if(d>0){if(!h)continue;let e=Math.max(M,l/2),t;if(![0,1,2,3].some(e=>!v[e]&&p[e]===n)){let t,i,l=(v.findIndex(e=>null!==e)<=1?[2,3]:[0,1]).filter(t=>!v[t]&&n-p[t]>=e&&n>p[t]);l.length>0&&a.push(l[Math.floor(Math.random()*l.length)])}}else{let e=Math.max(...p);if(n-e<M)continue;if(h)if(Math.random()<L){let e=Math.random()>.5?0:1;a.push(e,e+2)}else a.push(Math.random()>.5?0:3);else T=1===T?2:1,t>=1&&Math.random()>.7&&(T=Math.random()>.5?0:3),a.push(T)}IS_MOBILE&&a.length>2&&(a=a.slice(0,2));let i=[],c=Math.max(1.5*o,1.4*M);for(let e of a)v[e]||n-p[e]<c||n<=p[e]||i.push(e);if(0===i.length&&h&&0===d){let e=[0,1,2,3].filter(e=>!v[e]&&n-p[e]>=c&&n>p[e]);e.length>0&&i.push(e[Math.floor(Math.random()*e.length)])}let s=!1,r;if(0===d&&S&&!h&&t>=.7&&!_&&!A&&n-y>16*l){let t=40,a=0;for(let n=1;n<=t;n++)u[e+n]&&u[e+n].high>.85*u[e+n].avgHigh&&a++;a>.85*t&&(s=!0)}s&&i.length>0&&(i=[i[0]],y=n),i.forEach(e=>{let t=s,a={lane:e,time:n,endTime:n,hit:!1,missed:!1,isLong:t,isHolding:!1,isDead:!1,type:h?"beat":"melody",spawnTime:n};G.masterNotes.push(a),p[e]=n,t&&(v[e]=a)})}}v.forEach(e=>{if(e){let t=c(e.time+(l>0?l:.3));t>i&&(t=c(i)),e.endTime=t,e.endTime-e.time<Math.max(2*o,l)&&(e.isLong=!1)}})}function analyzeBPM(e){if(!e)return GAME_CONFIG.AUDIO.DEFAULT_BPM;const t=e.getChannelData(0),a=e.sampleRate;let n=[];const i=Math.floor(.05*a);for(let e=0;e<t.length&&e<120*a;e+=i){let a=0;for(let n=0;n<i&&e+n<t.length;n++)Math.abs(t[e+n])>a&&(a=Math.abs(t[e+n]));a>.3&&n.push(e)}if(n.length<2)return GAME_CONFIG.AUDIO.DEFAULT_BPM;let l=[];for(let e=1;e<n.length;e++)l.push(n[e]-n[e-1]);const o=void 0;let c=60/(l.reduce((e,t)=>e+t)/l.length/a);for(;c<GAME_CONFIG.AUDIO.BPM_MIN;)c*=2;for(;c>GAME_CONFIG.AUDIO.BPM_MAX;)c/=2;return Math.round(c)}function analyzeAudio(e){if(!analyser||G.paused||!G.playing)return;G.freqDataArray||(G.freqDataArray=new Uint8Array(analyser.frequencyBinCount)),analyser.getByteFrequencyData(G.freqDataArray);let t=0,a=0;for(let e=2;e<10;e++)t+=G.freqDataArray[e];t/=8;for(let e=12;e<160;e++)a+=G.freqDataArray[e];a/=148,G.avgK=.96*(G.avgK||40)+.04*t,G.avgL=.96*(G.avgL||30)+.04*a,t>1.5*G.avgK&&t>50&&(G.lineGlow=Math.max(G.lineGlow,.6))}function loop(){if(!G.playing||G.paused)return;const e=performance.now();let t=(e-(G.lastFrameTime||e))/1e3,a;if(t>.5&&(t=.5),G.lastFrameTime=e,G.touchLockTimer>0&&(G.touchLockTimer-=t),G.audioStarted){if(G.virtualTime+=t,G.mediaEl){const e=G.mediaEl.currentTime;if(0===e&&G.virtualTime>.1)G.virtualTime=0;else if(e>0&&e!==G.lastMediaTime){let t=e-G.virtualTime;if(Math.abs(t)>1.5)G.virtualTime=e;else if(G.touchLockTimer<=0&&Math.abs(t)>.05){let e=.05*t;e>.01&&(e=.01),e<-.01&&(e=-.01),G.virtualTime+=e}G.lastMediaTime=e}}a=G.virtualTime}else if(G.leadInTimer+=t,G.leadInTimer>=G.leadInTime){if(G.audioStarted=!0,G.mediaEl){G.mediaEl.currentTime=0,G.mediaEl.muted=!1,G.mediaEl.volume=1,G.mediaEl.play().catch(e=>{}),masterGainNode&&(masterGainNode.gain.cancelScheduledValues(actx.currentTime),masterGainNode.gain.setValueAtTime(0,actx.currentTime),masterGainNode.gain.linearRampToValueAtTime(G.volume,actx.currentTime+1));const e=document.getElementById("bg-video");e&&(e.style.transition="opacity 1.5s ease-in-out",e.style.opacity=1)}G.virtualTime=0,G.lastMediaTime=0,a=0}else a=G.leadInTimer-G.leadInTime,G.virtualTime=a;if(G.isFever){if(G.fever<=0)endFeverEffect();else{let e=G.fever/100;const t=GAME_CONFIG.FEVER.FILTER_MIN_FREQ,a=GAME_CONFIG.FEVER.FILTER_MAX_FREQ;feverFilter.frequency.setTargetAtTime(t+(a-t)*(1-e),actx.currentTime,.05),G.fever-=GAME_CONFIG.FEVER.DRAIN_RATE}updateHUD()}G.audioStarted&&a-G.lastAnalysisTime>.033&&(analyzeAudio(a),G.lastAnalysisTime=a),ctx.clearRect(0,0,cvs.width,cvs.height),G.isFever&&(ctx.fillStyle="rgba(0,0,0,0.6)",ctx.fillRect(0,0,cvs.width,cvs.height),ctx.save(),ctx.globalCompositeOperation="source-over",ctx.fillStyle=G.cachedGradients.fever,ctx.fillRect(0,0,cvs.width,JUDGE_Y),ctx.restore());const n=G.isFever?GAME_CONFIG.SPEED.FEVER_ACCEL:1;void 0===G.speedLerp&&(G.speedLerp=n),G.speedLerp+=.05*(n-G.speedLerp),G.currentSpeed=G.baseSpeed*G.speedLerp*(G.scrollSpeed||1)*.85;const i=G.currentSpeed/(IS_MOBILE?GAME_CONFIG.SPEED.MOBILE_SCALE:1),l=void 0,o=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X,c=8e3,s=(JUDGE_Y+c)/(1e3*i),r=2;G.holdingLanes.fill(!1);for(let e=0;e<G.notes.length;e++)!G.notes[e].isDead&&G.notes[e].isLong&&G.notes[e].isHolding&&(G.holdingLanes[G.notes[e].lane]=!0);for(let e=0;e<4;e++)if(G.holdingLanes[e]&&(G.beams[e]=1),G.beams[e]>0){const t=ctx.createLinearGradient(0,JUDGE_Y,0,0);t.addColorStop(0,"rgba(0, 243, 255, 0.4)"),t.addColorStop(1,"rgba(0, 243, 255, 0)"),ctx.fillStyle=t,ctx.globalAlpha=.8*G.beams[e],ctx.fillRect(e*o+5*SCALE_X,0,o-10*SCALE_X,JUDGE_Y),G.holdingLanes[e]||(G.beams[e]*=.85,G.beams[e]<.01&&(G.beams[e]=0))}ctx.globalAlpha=1;for(let e=G.notes.length-1;e>=0;e--){const t=G.notes[e];if(t.isDead)continue;const n=t.time-(a+G.audioOffset),l=(t.isLong?t.endTime:t.time)-(a+G.audioOffset);if(n>s)continue;if(t.isLong){if(l<-2&&!t.isHolding){t.isDead=!0;continue}}else if(n<-2){t.isDead=!0;continue}let c=JUDGE_Y-1e3*n*i,r=JUDGE_Y-1e3*l*i,d=1;const u=GAME_CONFIG.COLORS.NOTE_LANES[t.lane];if(t.missed)d=.4;else if(t.hit)if(t.isLong&&t.isHolding)c=JUDGE_Y,G.holdingLanes[t.lane]=!0;else{const e=a-(t.hitTime||Math.max(0,a));if(e>.5){t.isDead=!0;continue}d=Math.pow(1-e/.5,1.5),c=JUDGE_Y}else c>JUDGE_Y&&!t.hit&&!t.isLong&&(d=.4);if(ctx.globalAlpha=d,t.isLong&&(ctx.globalAlpha=(t.missed?.3:t.isHolding?.8+.2*Math.sin(.02*Date.now()):.7)*d,ctx.fillStyle=u,c-r>0&&ctx.fillRect(t.lane*o+5*SCALE_X,r,o-10*SCALE_X,c-r)),c<cvs.height+200&&r>-8e3&&(!t.isLong||!t.isHolding)){ctx.fillStyle=u;let e=1;t.hit&&!t.missed&&(e=1+1.5*(a-(t.hitTime||Math.max(0,a))));const n=(o-10*SCALE_X)*e,i=GAME_CONFIG.COLORS.NOTE_HEIGHT*(t.hit&&!t.missed?e:1),l=t.lane*o+(o-n)/2;ctx.fillRect(l,c-i/2,n,i),ctx.fillStyle="#ffffff";const s=4*(t.hit&&!t.missed?e:1);ctx.fillRect(l,c-s/2,n,s)}ctx.globalAlpha=1,t.isLong&&t.isHolding&&a+G.audioOffset>t.endTime+GAME_CONFIG.JUDGEMENT.WINDOW_GOOD&&(t.isHolding=!1,t.missed=!0,triggerJudge("MISS",t.lane));const m=void 0;l<(G.isFever?-.12:-.21)&&!t.hit&&(t.hit=!0,t.missed=!0,triggerJudge("MISS",t.lane)),r>cvs.height+500&&(t.isDead=!0)}ctx.save(),G.lineGlow*=.9,ctx.fillStyle=GAME_CONFIG.COLORS.NEON_RED,ctx.globalAlpha=.8,ctx.fillRect(0,JUDGE_Y-4,cvs.width,22),G.lineGlow>.1&&(ctx.fillStyle="#ffffff",ctx.globalAlpha=.8*G.lineGlow,ctx.fillRect(0,JUDGE_Y-4,cvs.width,22)),ctx.restore(),drawFX(),G.animId=requestAnimationFrame(loop)}function drawFX(){ctx.save();const e=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X;G.holdEffectTimer||(G.holdEffectTimer=[0,0,0,0]);for(let t=0;t<4;t++)G.holdingLanes[t]?(G.holdEffectTimer[t]=(G.holdEffectTimer[t]||0)+16,G.holdEffectTimer[t]>120&&(spawnImplosion(t),G.holdEffectTimer[t]=0),ctx.fillStyle="#ffffff",ctx.globalAlpha=.9,ctx.beginPath(),ctx.ellipse(t*e+e/2+5*SCALE_X,JUDGE_Y,e/2-15*SCALE_X,6*SCALE_X,0,0,2*Math.PI),ctx.fill()):G.holdEffectTimer[t]=120;for(const e of G.particlePool)if(e.active)if(e.life-=e.decayRate||.1,e.life<=0)e.active=!1;else if(e.isGlow&&!IS_MOBILE){const t=Math.max(.1,300*e.life*SCALE_X),a=ctx.createRadialGradient(e.x,e.y||JUDGE_Y,0,e.x,e.y||JUDGE_Y,t);a.addColorStop(0,"#ffffff"),a.addColorStop(.2,e.color),a.addColorStop(1,"transparent"),ctx.fillStyle=a,ctx.globalAlpha=.8*e.life,ctx.beginPath(),ctx.arc(e.x,e.y||JUDGE_Y,t,0,2*Math.PI),ctx.fill()}else if(e.isRing&&!IS_MOBILE)ctx.beginPath(),ctx.arc(e.x,e.y,80*(1-e.life)*SCALE_X,0,2*Math.PI),ctx.strokeStyle=e.color,ctx.lineWidth=3*e.life,ctx.globalAlpha=.5*e.life,ctx.stroke();else if(e.isRevRing&&!IS_MOBILE)ctx.beginPath(),ctx.arc(e.x,e.y,80*e.life*SCALE_X,0,2*Math.PI),ctx.strokeStyle=e.color,ctx.lineWidth=3*(1-e.life)+1,ctx.globalAlpha=.5*(1-e.life),ctx.stroke();else if(!e.isGlow&&!e.isRing&&!e.isRevRing)if(e.x+=e.vx*SCALE_X,e.y+=e.vy,ctx.fillStyle=e.color,ctx.globalAlpha=e.life,IS_MOBILE){const t=(e.size||2)*SCALE_X*2.5;ctx.fillRect(e.x-t/2,e.y-t/2,t,t)}else ctx.beginPath(),ctx.arc(e.x,e.y,(e.size||2)*SCALE_X,0,2*Math.PI),ctx.fill();if(G.mediaEl&&G.elProgressBar&&(G.elProgressBar.style.transform=`scaleX(${G.mediaEl.currentTime/G.mediaEl.duration||0})`),G.judgeTimer>0){void 0===G.judgeScale&&(G.judgeScale=1),G.judgeScale+=.15*(1-G.judgeScale);const e=.2*CH;ctx.textAlign="center",ctx.globalAlpha=Math.min(1,2.5*G.judgeTimer),ctx.save(),ctx.translate(CW/2,e),ctx.scale(G.judgeScale,G.judgeScale),ctx.font=`italic 900 ${45*SCALE_X}px 'Segoe UI', sans-serif`,ctx.fillStyle=G.judgeColor,IS_MOBILE||(ctx.shadowColor=G.judgeColor,ctx.shadowBlur=15),ctx.fillText(G.judgeText,0,0),ctx.restore(),G.combo>0&&(ctx.shadowBlur=0,ctx.font=`900 ${75*SCALE_X}px 'Segoe UI', sans-serif`,ctx.fillStyle="#ffffff",ctx.fillText(G.combo,CW/2,e+70*SCALE_X),ctx.font=`bold ${16*SCALE_X}px 'Segoe UI', sans-serif`,ctx.fillStyle="#888888",ctx.fillText("COMBO",CW/2,e+95*SCALE_X)),G.judgeTimer-=.016}ctx.restore()}preRenderSFX(),G.lastAudioTime=0,G.lastSyncTimestamp=performance.now();const KEYS=["d","f","j","k"];function handleInputStart(e,t=!1){if(-1===e)return;const a=performance.now();if(t&&a-G.lastTapTime[e]<5)return;G.lastTapTime[e]=a,G.touchLockTimer=.5,G.keysHeld[e]=!0;const n=G.domKeys[e];n&&n.classList.add("active"),G.beams[e]=1;let i=G.virtualTime;if(G.playing&&!G.paused){playSFX(G.isFever?"fever-hit":"hit");const a=i+G.audioOffset,n=GAME_CONFIG.JUDGEMENT.HIT_DETECTION_RANGE*(t?GAME_CONFIG.JUDGEMENT.MOBILE_HIT_WINDOW_SCALE:1),l=G.notes.find(t=>t.lane===e&&!t.hit&&!t.missed&&Math.abs(t.time-a)<=n);if(l){const n=Math.abs(l.time-a),o=GAME_CONFIG.JUDGEMENT,c=t?o.MOBILE_HIT_WINDOW_SCALE:1;if(n>o.WINDOW_GOOD*c)l.hit=!0,l.missed=!0,triggerJudge("MISS",e);else if(l.hit=!0,l.hitTime=i,l.isLong)l.isHolding=!0;else{let t="GOOD";n<o.WINDOW_PERFECT*c?t="PERFECT":n<o.WINDOW_GREAT*c&&(t="GREAT"),triggerJudge(t,e)}}}}function handleInputEnd(e){if(-1!==e){G.keysHeld[e]=!1;let t=G.virtualTime;const a=G.notes.find(t=>t.lane===e&&t.isLong&&t.isHolding&&!t.processedEnd);if(a){a.isHolding=!1,a.processedEnd=!0;const n=Math.abs(a.endTime-(t+G.audioOffset)),i=GAME_CONFIG.JUDGEMENT;n<i.WINDOW_PERFECT?triggerJudge("PERFECT",e):n<i.WINDOW_GREAT?triggerJudge("GREAT",e):n<i.WINDOW_GOOD?triggerJudge("GOOD",e):(a.missed=!0,triggerJudge("MISS",e))}const n=document.getElementById(`k${e}`);n&&n.classList.remove("active")}}document.addEventListener("keydown",e=>{if(void 0!==actx&&"suspended"===actx.state&&actx.resume(),G.playing){const t=["Space"," ","d","f","j","k","D","F","J","K"];(t.includes(e.key)||t.includes(e.code))&&e.preventDefault()}if(e.repeat)return;"Escape"===e.key&&(G.paused?resumeGame():togglePause());const t=void 0;handleInputStart(KEYS.indexOf(e.key.toLowerCase()),!1)},{passive:!1}),document.addEventListener("keyup",e=>{const t=void 0;handleInputEnd(KEYS.indexOf(e.key.toLowerCase()))}),document.addEventListener("gesturestart",e=>e.preventDefault()),document.addEventListener("gesturechange",e=>e.preventDefault()),document.addEventListener("gestureend",e=>e.preventDefault());const touchStage=document.getElementById("gear-stage"),activeTouches={},laneTouchCount=[0,0,0,0],getGameRect=()=>touchStageRect||touchStage.getBoundingClientRect();function enforceTouchIntegrity(e){if(0===e.touches.length){for(let e=0;e<4;e++)G.keysHeld[e]&&handleInputEnd(e);laneTouchCount.fill(0);for(let e in activeTouches)delete activeTouches[e]}}function getInactiveParticle(){for(let e=0;e<G.particlePool.length;e++)if(!G.particlePool[e].active)return G.particlePool[e];return null}function spawnExplosion(e,t){const a=t||GAME_CONFIG.COLORS.NOTE_LANES[e],n=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X,i=e*n+n/2,l=IS_MOBILE?6:15;let o=getInactiveParticle();o&&(o.active=!0,o.x=i,o.y=JUDGE_Y,o.isGlow=!0,o.isRing=!1,o.isRevRing=!1,o.life=1,o.color=a,o.vx=0,o.vy=0,o.decayRate=.05);for(let e=0;e<l;e++){let e=getInactiveParticle();e&&(e.active=!0,e.x=i,e.y=JUDGE_Y,e.isGlow=!1,e.isRing=!1,e.isRevRing=!1,e.vx=20*(Math.random()-.5),e.vy=15*(Math.random()-1.2),e.life=.7,e.color=a,e.size=3+2*Math.random(),e.decayRate=IS_MOBILE?.08:.05)}let c=getInactiveParticle();c&&(c.active=!0,c.x=i,c.y=JUDGE_Y,c.isGlow=!1,c.isRing=!0,c.isRevRing=!1,c.life=1,c.color=a,c.vx=0,c.vy=0,c.decayRate=.05)}function spawnImplosion(e){const t=GAME_CONFIG.COLORS.NOTE_LANES[e],a=GAME_CONFIG.COLORS.LANE_WIDTH*SCALE_X,n=e*a+a/2,i=IS_MOBILE?6:15;let l=getInactiveParticle();l&&(l.active=!0,l.x=n,l.y=JUDGE_Y,l.isGlow=!0,l.isRing=!1,l.isRevRing=!1,l.life=1,l.color=t,l.vx=0,l.vy=0,l.decayRate=.15);for(let e=0;e<i;e++){let e=getInactiveParticle();if(e){e.active=!0,e.isGlow=!1,e.isRing=!1,e.isRevRing=!1,e.color=t,e.size=3+2*Math.random(),e.decayRate=IS_MOBILE?.08:.05;let a=1/e.decayRate,i=20*(Math.random()-.5),l=15*(Math.random()-1.2);e.x=n+i*a*SCALE_X,e.y=JUDGE_Y+l*a,e.vx=-i,e.vy=-l,e.life=1}}let o=getInactiveParticle();o&&(o.active=!0,o.x=n,o.y=JUDGE_Y,o.isGlow=!1,o.isRing=!1,o.isRevRing=!0,o.life=1,o.color=t,o.vx=0,o.vy=0,o.decayRate=.1)}touchStage.addEventListener("touchstart",e=>{e.cancelable&&e.preventDefault();const t=getGameRect();for(let a=0;a<e.changedTouches.length;a++){const n=e.changedTouches[a],i=void 0;if(n.clientY-t.top>.35*t.height){const e=n.clientX-t.left;let a=Math.floor(e/t.width*4);a=Math.max(0,Math.min(3,a)),activeTouches[n.identifier]=a,laneTouchCount[a]++,handleInputStart(a,!0)}}},{passive:!1}),touchStage.addEventListener("touchmove",e=>{e.cancelable&&e.preventDefault();const t=getGameRect();for(let a=0;a<e.changedTouches.length;a++){const n=e.changedTouches[a],i=activeTouches[n.identifier];if(void 0!==i){const e=n.clientX-t.left,a=n.clientY-t.top;let l=Math.floor(e/t.width*4);l=Math.max(0,Math.min(3,l));const o=a>.35*t.height;o&&l!==i?(laneTouchCount[i]--,laneTouchCount[i]<=0&&(laneTouchCount[i]=0,handleInputEnd(i)),activeTouches[n.identifier]=l,laneTouchCount[l]++,handleInputStart(l,!0)):o?o&&-1===i&&(activeTouches[n.identifier]=l,laneTouchCount[l]++,handleInputStart(l,!0)):(laneTouchCount[i]>0&&(laneTouchCount[i]--,0===laneTouchCount[i]&&handleInputEnd(i)),activeTouches[n.identifier]=-1)}}},{passive:!1}),["touchend","touchcancel"].forEach(e=>{touchStage.addEventListener(e,e=>{e.cancelable&&e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const a=e.changedTouches[t],n=activeTouches[a.identifier];void 0!==n&&-1!==n&&(laneTouchCount[n]--,laneTouchCount[n]<=0&&(laneTouchCount[n]=0,handleInputEnd(n))),delete activeTouches[a.identifier]}enforceTouchIntegrity(e)},{passive:!1})});const JUDGE_COLORS={PERFECT:"#ffeb3b",GREAT:"#00f3ff",GOOD:"#4caf50",MISS:"#f44336"};function triggerJudge(e,t){const a=GAME_CONFIG.JUDGEMENT,n=JUDGE_COLORS[e]||"#ffffff";G.judgeText=e,G.judgeColor=n,G.judgeTimer=1,G.judgeScale=1.5;const i=void 0!==t?t:0;if("MISS"===e){if(G.lineGlow=0,G.combo=0,G.stats.miss++,G.hp=Math.max(0,G.hp-a.HP_LOSS_MISS),G.failEnabled&&G.hp<=0)return finishGame(!1),void 0;G.isFever&&endFeverEffect()}else G.lineGlow=1,spawnExplosion(i,n),G.combo++,G.stats[e.toLowerCase()]++,G.stats.maxCombo=Math.max(G.combo,G.stats.maxCombo),"PERFECT"===e?G.hp=Math.min(100,G.hp+a.HP_GAIN_PERFECT):"GREAT"===e?G.hp=Math.min(100,G.hp+a.HP_GAIN_GREAT):"GOOD"===e&&(G.hp=Math.min(100,G.hp+a.HP_GAIN_GOOD)),G.score+=("PERFECT"===e?a.SCORE_PERFECT:"GREAT"===e?a.SCORE_GREAT:a.SCORE_GOOD)*(G.isFever?GAME_CONFIG.FEVER.SCORE_MULTIPLIER:1),G.isFever||(G.fever=Math.min(GAME_CONFIG.FEVER.MAX_VALUE,G.fever+GAME_CONFIG.FEVER.GAIN_PER_HIT),G.fever>=GAME_CONFIG.FEVER.MAX_VALUE&&startFever());updateHUD()}function startFever(){G.isFever=!0,updateHUD(),playSFX("fever-entry"),feverFilter.frequency.setTargetAtTime(800,actx.currentTime,.05),feverBassNode&&feverBassNode.gain.setTargetAtTime(GAME_CONFIG.FEVER.BASS_GAIN,actx.currentTime,.1),document.getElementById("gear-stage").classList.add("fever-mode-active")}function endFeverEffect(){G.isFever=!1,G.fever=0,feverFilter.frequency.setTargetAtTime(GAME_CONFIG.FEVER.FILTER_MAX_FREQ,actx.currentTime,.1),feverBassNode&&feverBassNode.gain.setTargetAtTime(0,actx.currentTime,.1),document.getElementById("gear-stage").classList.remove("fever-mode-active"),updateHUD()}function updateHUD(){G.elHpFill&&G.hp!==G.lastHudUpdate.hp&&(G.elHpFill.style.transform=`scaleY(${G.hp/100})`,G.lastHudUpdate.hp=G.hp),G.elFeverFill&&Math.abs(G.fever-G.lastHudUpdate.fever)>.1&&(G.elFeverFill.style.transform=`scaleY(${G.fever/100})`,G.lastHudUpdate.fever=G.fever)}function playSFX(e,t=1){const a=actx.currentTime;if("suspended"===actx.state&&actx.resume(),"hit"===e||"fever-hit"===e){if(IS_MOBILE)return;const n="fever-hit"===e?sfxBuffers.feverHit:sfxBuffers.hit;if(n){const e=actx.createBufferSource();e.buffer=n;const i=actx.createGain();i.gain.value=t,e.connect(i),i.connect(sfxBus),e.start(a)}else{const n=actx.createOscillator(),i=actx.createGain(),l="fever-hit"===e;n.type=l?"sawtooth":"triangle";const o=l?200:2e3,c=40,s=l?.1:.5;n.frequency.setValueAtTime(o,a),n.frequency.exponentialRampToValueAtTime(c,a+s),i.gain.setValueAtTime(.5*t,a),i.gain.exponentialRampToValueAtTime(.001,a+s),n.connect(i),i.connect(sfxBus),n.start(a),n.stop(a+s)}}else if("fever-entry"===e){if(!noiseBuffer)return;const e=actx.createBufferSource();e.buffer=noiseBuffer;const t=actx.createBiquadFilter();t.type="lowpass",t.frequency.setValueAtTime(200,a),t.frequency.exponentialRampToValueAtTime(5e3,a+.8);const n=actx.createGain();n.gain.setValueAtTime(0,a),n.gain.linearRampToValueAtTime(1,a+.6),n.gain.linearRampToValueAtTime(0,a+1),e.connect(t),t.connect(n),n.connect(sfxBus),e.start(a)}}function playMenuImpact(){if(!actx)return;const e=actx.currentTime,t=actx.createOscillator(),a=actx.createGain();t.connect(a),a.connect(masterGainNode),t.type="triangle",t.frequency.setValueAtTime(150,e),t.frequency.exponentialRampToValueAtTime(.01,e+.3),a.gain.setValueAtTime(.5,e),a.gain.exponentialRampToValueAtTime(.01,e+.3),t.start(e),t.stop(e+.3)}function handleBoxClick(e,t){document.getElementById("inp-"+t).click()}async function loadMedia(e,t){if(!e)return;G.mediaEl&&(G.mediaEl.pause(),G.mediaEl.src="",G.mediaEl.load()),G.mediaEl=null;const a=document.getElementById("bg-video");a.style.opacity=0,a.src="",document.getElementById("box-audio").classList.remove("selected"),document.getElementById("box-video").classList.remove("selected"),document.getElementById("name-audio").innerText="Select File",document.getElementById("name-video").innerText="Select File",document.getElementById("inp-"+("audio"===t?"video":"audio")).value="","suspended"===actx.state&&await actx.resume();const n=URL.createObjectURL(e),i=document.getElementById("song-name-text");if(i&&(i.innerText=e.name.replace(/\.[^/.]+$/,"").toUpperCase()),document.getElementById("box-"+t).classList.add("selected"),document.getElementById("name-"+t).innerText=e.name,"video"===t)a.src=n,a.load(),a.style.opacity=0,G.mediaEl=a,G.mediaType="video";else{const e=new Audio;e.src=n,e.crossOrigin="anonymous",G.mediaEl=e,G.mediaType="audio"}try{const t=await e.arrayBuffer();G.currentAudioBuffer=await actx.decodeAudioData(t),G.bpm=analyzeBPM(G.currentAudioBuffer)}catch(e){void 0,G.bpm=GAME_CONFIG.AUDIO.DEFAULT_BPM}G.mediaEl.loop=!1,G.mediaEl.addEventListener("ended",()=>{setTimeout(()=>{G.playing&&!G.paused&&finishGame(!0)},2500)}),document.getElementById("diff-opt").style.display="block"}async function preInitGame(e){const t=document.getElementById("difficulty-display");if(t){t.style.display="block";const a=" - "+G.scrollSpeed.toFixed(2)+"x";e<=.7?(t.innerText="EASY"+a,t.style.color="#00ff00",t.style.textShadow="0 0 10px #00ff00"):e<=1?(t.innerText="NORMAL"+a,t.style.color="var(--neon-blue)",t.style.textShadow="0 0 10px var(--neon-blue)"):(t.innerText="HARD"+a,t.style.color="var(--neon-pink)",t.style.textShadow="0 0 10px var(--neon-pink)")}document.activeElement instanceof HTMLElement&&document.activeElement.blur(),window.focus(),document.body.focus(),"suspended"===actx.state&&await actx.resume(),G.diff=e,G.failEnabled=document.getElementById("chk-fail").checked,G.baseSpeed=G.bpm/120*1,G.currentAudioBuffer&&generateBeatmap(G.currentAudioBuffer,G.diff);try{feverFilter.disconnect()}catch(e){}if(feverBassNode=actx.createBiquadFilter(),feverBassNode.type="lowshelf",feverBassNode.frequency.value=200,feverBassNode.gain.value=0,mainSource)try{mainSource.disconnect()}catch(e){}try{"video"===G.mediaType?(G.videoSourceNode||(G.videoSourceNode=actx.createMediaElementSource(G.mediaEl)),mainSource=G.videoSourceNode):mainSource=actx.createMediaElementSource(G.mediaEl),mainSource.connect(analyser),analyser.connect(feverFilter),feverFilter.connect(feverBassNode),feverBassNode.connect(masterGainNode)}catch(e){}document.getElementById("menu-screen").classList.add("hidden"),"running"!==actx.state&&await actx.resume(),startCountdown()}function startCountdown(){"suspended"===actx.state&&actx.resume(),G.screen="COUNTDOWN";const e=document.getElementById("bg-video");e&&(e.style.transition="opacity 0.5s",e.style.opacity=0);const t=document.getElementById("volume-slider");if(t&&masterGainNode){const e=parseFloat(t.value);G.volume=e,masterGainNode.gain.cancelScheduledValues(actx.currentTime),masterGainNode.gain.setValueAtTime(e,actx.currentTime)}G.smoothTime=0,G.mediaEl&&(G.mediaEl.pause(),G.mediaEl.currentTime=0);const a=document.getElementById("cd-num");document.getElementById("cd-screen").classList.remove("hidden");const n=document.getElementById("menu-bgm");if(n){G.menuFadeTimer&&clearInterval(G.menuFadeTimer);let e=menuGainNode?menuGainNode.gain.value:n.volume,t=20;const a=setInterval(()=>{e=Math.max(0,e-.05),menuGainNode?menuGainNode.gain.value=e:n.volume=e,t--,(e<=0||t<=0)&&(menuGainNode?menuGainNode.gain.value=0:n.volume=0,n.pause(),n.currentTime=0,clearInterval(a))},30)}const i=setInterval(()=>{window.focus(),document.body.focus()},500);let l=3;a.innerText=l;let o=setInterval(()=>{l--,1===l&&G.mediaEl&&(G.mediaEl.muted=!0,G.mediaEl.volume=0,G.mediaEl.play().then(()=>{setTimeout(()=>{G.mediaEl.pause(),G.mediaEl.currentTime=0},400)}).catch(e=>{})),l>0?a.innerText=l:0===l?a.innerText="GO!":(clearInterval(o),clearInterval(i),document.getElementById("cd-screen").classList.add("hidden"),window.focus(),document.activeElement&&document.activeElement.blur(),document.body.focus(),setTimeout(()=>{startGame()},50))},1e3)}function initGameValues(){G.domKeys=[0,1,2,3].map(e=>document.getElementById(`k${e}`)),G.domKeys.forEach(e=>{e&&e.classList.remove("active")}),G.elHpFill=document.getElementById("hp-fill"),G.elFeverFill=document.getElementById("fever-fill"),G.elProgressBar=document.getElementById("song-progress-bar");const e=document.getElementById("gear-stage");if(G.hp=100,G.score=0,G.combo=0,G.maxCombo=0,G.fever=0,G.isFever=!1,G.playing=!1,G.stats={perfect:0,great:0,good:0,miss:0,maxCombo:0},G.notes=G.masterNotes?G.masterNotes.map(e=>({...e})):[],G.particles=[],G.beams=[0,0,0,0],G.holdingLanes=[!1,!1,!1,!1],G.keysHeld=[!1,!1,!1,!1],G.lastTapTime=[0,0,0,0],G.holdEffectTimer=[120,120,120,120],G.virtualTime=0,G.lastAudioSync=void 0,G.lastAnalysisTime=0,G.lastMediaTime=0,G.judgeTimer=0,G.lineGlow=0,G.speedLerp=1,G.leadInTimer=0,G.audioStarted=!1,G.leadInTime=2,G.lastFrameTime=performance.now(),G.lastSyncTimestamp=performance.now(),G.touchLockTimer=0,G.particlePool&&G.particlePool.forEach(e=>e.active=!1),void 0!==laneTouchCount&&laneTouchCount.fill(0),void 0!==activeTouches)for(let e in activeTouches)delete activeTouches[e];G.elProgressBar&&(G.elProgressBar.style.transform="scaleX(0)"),e&&e.classList.remove("fever-mode-active"),updateHUD()}function startGame(){initGameValues(),G.screen="PLAYING",G.playing=!0,G.paused=!1,resizeCanvas(),G.animId&&cancelAnimationFrame(G.animId),G.animId=requestAnimationFrame(loop)}function togglePause(){"PLAYING"!==G.screen&&"PAUSED"!==G.screen||G.paused||(G.paused=!0,G.audioStarted&&G.mediaEl&&G.mediaEl.pause(),cancelAnimationFrame(G.animId),document.getElementById("pause-screen").classList.remove("hidden"))}function resumeGame(){document.getElementById("pause-screen").classList.add("hidden");const e=document.getElementById("cd-screen"),t=document.getElementById("cd-num");e.classList.remove("hidden"),e.style.background="rgba(0,0,0,0.5)",e.style.backdropFilter="blur(2px)",e.style.webkitBackdropFilter="blur(2px)";let a=3;t.innerText=a;const n=setInterval(()=>{a--,a>0?t.innerText=a:(clearInterval(n),e.classList.add("hidden"),e.style.background="",e.style.backdropFilter="",e.style.webkitBackdropFilter="",G.paused=!1,G.audioStarted&&G.mediaEl&&G.mediaEl.play(),G.lastFrameTime=performance.now(),G.virtualTime=G.audioStarted&&G.mediaEl?G.mediaEl.currentTime:0,loop())},1e3)}function retryGame(){G.paused=!1,cancelAnimationFrame(G.animId),G.mediaEl&&(G.mediaEl.pause(),G.mediaEl.currentTime=0),stopResultMusic(),initGameValues(),document.getElementById("pause-screen").classList.add("hidden"),document.getElementById("result-screen").classList.add("hidden");const e=document.getElementById("difficulty-display");e&&(e.style.display="block"),window.focus(),document.activeElement&&document.activeElement.blur(),document.body.focus(),startCountdown()}function backToMenu(){G.playing=!1,G.paused=!1,G.animId&&cancelAnimationFrame(G.animId),G.mediaEl&&(G.mediaEl.pause(),G.mediaEl.currentTime=0),stopResultMusic(),initGameValues();const e=void 0;["judge-txt"].forEach(e=>{const t=document.getElementById(e);t&&(t.innerText="",t.style.opacity="0",t.className="")}),ctx&&ctx.clearRect(0,0,cvs.width,cvs.height),document.getElementById("pause-screen").classList.add("hidden"),document.getElementById("result-screen").classList.add("hidden"),document.getElementById("cd-screen").classList.add("hidden"),document.getElementById("gear-stage").classList.remove("fever-mode-active"),document.getElementById("diff-opt").style.display="none",document.getElementById("box-audio").classList.remove("selected"),document.getElementById("box-video").classList.remove("selected"),document.getElementById("name-audio").innerText="Select File",document.getElementById("name-video").innerText="Select File",document.getElementById("inp-audio").value="",document.getElementById("inp-video").value="",window.focus(),document.activeElement&&document.activeElement.blur(),document.body.focus(),G.screen="MENU",document.getElementById("menu-screen").classList.remove("hidden"),document.getElementById("start-overlay").style.display="none",document.getElementById("menu-main-content").style.visibility="visible",tryPlayMenuBgm()}function playResultMusicRobust(e){const t=e?document.getElementById("bgm-clear"):document.getElementById("bgm-fail");let a=null;if(e?(clearSource||(clearSource=actx.createMediaElementSource(t),clearGain=actx.createGain(),clearSource.connect(clearGain),clearGain.connect(masterGainNode)),a=clearGain):(failSource||(failSource=actx.createMediaElementSource(t),failGain=actx.createGain(),failSource.connect(failGain),failGain.connect(masterGainNode)),a=failGain),a){a.gain.setValueAtTime(0,actx.currentTime),t.currentTime=0,t.loop=!0,t.load();const e=t.play();void 0!==e&&e.then(()=>{let e=0;const t=.4;resultFadeTimer&&clearInterval(resultFadeTimer),resultFadeTimer=setInterval(()=>{e+=.02,e>=t?(a.gain.value=t,clearInterval(resultFadeTimer)):a.gain.value=e},50)}).catch(e=>{})}}function stopResultMusic(){resultFadeTimer&&clearInterval(resultFadeTimer);const e=document.getElementById("bgm-clear"),t=document.getElementById("bgm-fail");e&&(e.pause(),e.currentTime=0),t&&(t.pause(),t.currentTime=0)}function finishGame(e){G.playing=!1,G.screen="RESULT",cancelAnimationFrame(G.animId),G.mediaEl.pause(),playResultMusicRobust(e);const t=void 0;document.getElementById("result-screen").classList.remove("hidden");const a=document.getElementById("res-rank"),n=document.getElementById("res-title"),i=document.getElementById("res-fc");i&&i.classList.add("hidden"),document.getElementById("st-max-combo").innerText=G.stats.maxCombo,document.getElementById("st-perf").innerText=G.stats.perfect,document.getElementById("st-great").innerText=G.stats.great,document.getElementById("st-good").innerText=G.stats.good,document.getElementById("st-miss").innerText=G.stats.miss,document.getElementById("res-score").innerText=Math.floor(G.score);const l=G.stats.perfect+G.stats.great+G.stats.good+G.stats.miss;if(l>0&&(updateStatBar("bar-perf",G.stats.perfect,l),updateStatBar("bar-great",G.stats.great,l),updateStatBar("bar-good",G.stats.good,l),updateStatBar("bar-miss",G.stats.miss,l)),e){n.innerText="STAGE CLEAR";let e=1*G.stats.perfect+.7*G.stats.great+.3*G.stats.good,t=l>0?e/l:0,o="D",c="#888888";t>=.99?(o="SSS",c="#ffffff"):t>=.96?(o="SS",c="#ffcc00"):t>=.9?(o="S",c="#00f3ff"):t>=.8?(o="A",c="#00ff00"):t>=.7?(o="B",c="#ffff00"):t>=.6&&(o="C",c="#ffaa00"),a.innerText=o,a.style.color=c,a.style.textShadow="SSS"===o?"0 0 20px #fff, 0 0 40px #ffcc00":`0 0 20px ${c}, 0 0 40px ${c}`,0===G.stats.miss&&l>0&&i&&i.classList.remove("hidden")}else n.innerText="GAME OVER",a.innerText="F",a.style.color="#ff3333",a.style.textShadow="0 0 20px #ff3333, 0 0 40px #ff3333";const o=document.getElementById("difficulty-display");o&&(o.style.display="none")}function updateStatBar(e,t,a){const n=document.getElementById(e);n&&(n.style.width=t/a*100+"%")}function changeSpeed(e){const t=GAME_CONFIG.SPEED.OPTIONS;G.scrollSpeedIndex+=e,G.scrollSpeedIndex<0&&(G.scrollSpeedIndex=0),G.scrollSpeedIndex>=t.length&&(G.scrollSpeedIndex=t.length-1),G.scrollSpeed=t[G.scrollSpeedIndex];const a=document.getElementById("speed-display");a&&(a.innerText=GAME_CONFIG.SPEED.LABELS[G.scrollSpeedIndex])}function tryPlayMenuBgm(){const e=document.getElementById("menu-bgm");if(e&&"MENU"===G.screen){const t=.24;menuGainNode||(menuSource=actx.createMediaElementSource(e),menuGainNode=actx.createGain(),menuSource.connect(menuGainNode),menuGainNode.connect(masterGainNode)),G.menuFadeTimer&&clearInterval(G.menuFadeTimer),menuGainNode.gain.setValueAtTime(0,actx.currentTime),e.loop=!0;const a=e.play();void 0!==a&&a.then(()=>{G.menuFadeTimer=setInterval(()=>{let e=menuGainNode.gain.value;e<t?menuGainNode.gain.value=Math.min(t,e+.02):clearInterval(G.menuFadeTimer)},100)}).catch(e=>{void 0})}}G.particlePool=Array.from({length:500},()=>({active:!1,x:0,y:0,vx:0,vy:0,life:0,color:"",size:0,isGlow:!1,isRing:!1,isRevRing:!1,decayRate:.05})),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("start-overlay"),t=document.getElementById("menu-main-content"),a=document.getElementById("volume-slider"),n=document.getElementById("volume-display"),i=document.getElementById("offset-slider"),l=document.getElementById("offset-display");i&&l&&(i.value=0,l.innerText="0.000s",i.addEventListener("input",e=>{const t=parseFloat(e.target.value);G.userOffset=t,G.audioOffset=G.baseOffset+G.userOffset;const a=t>0?"+":"";l.innerText=a+t.toFixed(3)+"s"})),a&&a.addEventListener("input",e=>{const t=parseFloat(e.target.value);G.volume=t,masterGainNode.gain.cancelScheduledValues(actx.currentTime),masterGainNode.gain.linearRampToValueAtTime(t,actx.currentTime+.05),n&&(n.innerText=Math.round(100*t)+"%")}),e&&(e.onclick=()=>{e.style.display="none",t.style.visibility="visible","suspended"===actx.state&&actx.resume(),preRenderSFX(),["bgm-clear","bgm-fail"].forEach(e=>{const t=document.getElementById(e);t&&(t.muted=!0,t.play().then(()=>{t.pause(),t.currentTime=0,t.muted=!1}).catch(()=>{}))}),tryPlayMenuBgm()})});
</script>
</body>
</html>